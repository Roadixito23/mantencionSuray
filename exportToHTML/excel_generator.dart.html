<html>
<head>
<title>excel_generator.dart</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
.s1 { color: #6aab73;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
excel_generator.dart</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">'dart:io'</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">'package:excel/excel.dart'</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">'package:path_provider/path_provider.dart'</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">'dart:convert'</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">'package:file_picker/file_picker.dart'</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">'package:intl/intl.dart'</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">'package:path/path.dart' </span><span class="s0">as path</span><span class="s2">;</span>

<span class="s3">class </span><span class="s0">ExcelGenerator </span><span class="s2">{</span>
  <span class="s4">// Método para cargar máquinas desde el archivo JSON</span>
  <span class="s0">static Future</span><span class="s2">&lt;</span><span class="s0">List</span><span class="s2">&lt;</span><span class="s0">Map</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">, </span><span class="s0">dynamic</span><span class="s2">&gt;&gt;&gt; </span><span class="s0">_cargarMaquinas</span><span class="s2">() </span><span class="s0">async </span><span class="s2">{</span>
    <span class="s3">try </span><span class="s2">{</span>
      <span class="s3">final </span><span class="s0">directory </span><span class="s2">= </span><span class="s0">await getApplicationDocumentsDirectory</span><span class="s2">();</span>
      <span class="s3">final </span><span class="s0">file </span><span class="s2">= </span><span class="s0">File</span><span class="s2">(</span><span class="s1">'</span><span class="s2">${</span><span class="s0">directory</span><span class="s2">.</span><span class="s0">path</span><span class="s2">}</span><span class="s1">/maquinas.json'</span><span class="s2">);</span>

      <span class="s3">if </span><span class="s2">(</span><span class="s0">await file</span><span class="s2">.</span><span class="s0">exists</span><span class="s2">()) {</span>
        <span class="s3">final </span><span class="s0">contenido </span><span class="s2">= </span><span class="s0">await file</span><span class="s2">.</span><span class="s0">readAsString</span><span class="s2">();</span>
        <span class="s3">final </span><span class="s0">List</span><span class="s2">&lt;</span><span class="s0">dynamic</span><span class="s2">&gt; </span><span class="s0">maquinasJson </span><span class="s2">= </span><span class="s0">jsonDecode</span><span class="s2">(</span><span class="s0">contenido</span><span class="s2">);</span>
        <span class="s3">return </span><span class="s0">maquinasJson</span><span class="s2">.</span><span class="s0">cast</span><span class="s2">&lt;</span><span class="s0">Map</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">, </span><span class="s0">dynamic</span><span class="s2">&gt;&gt;();</span>
      <span class="s2">}</span>
      <span class="s3">return </span><span class="s2">[];</span>
    <span class="s2">} </span><span class="s3">catch </span><span class="s2">(</span><span class="s0">e</span><span class="s2">) {</span>
      <span class="s0">print</span><span class="s2">(</span><span class="s1">'Error al cargar máquinas: </span><span class="s2">$</span><span class="s0">e</span><span class="s1">'</span><span class="s2">);</span>
      <span class="s3">return </span><span class="s2">[];</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

  <span class="s4">// Método para generar Excel con todas las máquinas y permitir al usuario elegir dónde guardarlo</span>
  <span class="s0">static Future</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">?&gt; </span><span class="s0">generarExcelMaquinas</span><span class="s2">() </span><span class="s0">async </span><span class="s2">{</span>
    <span class="s3">try </span><span class="s2">{</span>
      <span class="s4">// Cargar máquinas</span>
      <span class="s3">final </span><span class="s0">maquinas </span><span class="s2">= </span><span class="s0">await _cargarMaquinas</span><span class="s2">();</span>

      <span class="s3">if </span><span class="s2">(</span><span class="s0">maquinas</span><span class="s2">.</span><span class="s0">isEmpty</span><span class="s2">) {</span>
        <span class="s3">return null</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s4">// Crear un nuevo archivo Excel</span>
      <span class="s3">var </span><span class="s0">excel </span><span class="s2">= </span><span class="s0">Excel</span><span class="s2">.</span><span class="s0">createExcel</span><span class="s2">();</span>
      <span class="s3">var </span><span class="s0">sheet </span><span class="s2">= </span><span class="s0">excel</span><span class="s2">[</span><span class="s1">'Máquinas'</span><span class="s2">];</span>

      <span class="s4">// Definir encabezados</span>
      <span class="s0">_agregarEncabezados</span><span class="s2">(</span><span class="s0">sheet</span><span class="s2">);</span>

      <span class="s4">// Generar nombre de archivo predeterminado con formato dd/mm/yy</span>
      <span class="s3">final </span><span class="s0">dateFormat </span><span class="s2">= </span><span class="s0">DateFormat</span><span class="s2">(</span><span class="s1">'dd-MM-yy'</span><span class="s2">);</span>
      <span class="s3">final </span><span class="s0">nombreArchivoPredeterminado </span><span class="s2">= </span><span class="s1">'mantenimiento_excel_</span><span class="s2">${</span><span class="s0">dateFormat</span><span class="s2">.</span><span class="s0">format</span><span class="s2">(</span><span class="s0">DateTime</span><span class="s2">.</span><span class="s0">now</span><span class="s2">())}</span><span class="s1">.xlsx'</span><span class="s2">;</span>

      <span class="s4">// Abrir el selector de directorios para elegir dónde guardar</span>
      <span class="s0">String</span><span class="s2">? </span><span class="s0">outputDir </span><span class="s2">= </span><span class="s0">await FilePicker</span><span class="s2">.</span><span class="s0">platform</span><span class="s2">.</span><span class="s0">getDirectoryPath</span><span class="s2">(</span>
        <span class="s0">dialogTitle</span><span class="s2">: </span><span class="s1">'Seleccionar carpeta para guardar'</span><span class="s2">,</span>
      <span class="s2">);</span>

      <span class="s4">// Si el usuario canceló la operación</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s0">outputDir </span><span class="s2">== </span><span class="s3">null</span><span class="s2">) {</span>
        <span class="s3">return null</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s4">// Crear carpeta de imágenes dentro de la carpeta seleccionada</span>
      <span class="s3">final </span><span class="s0">imagenesDir </span><span class="s2">= </span><span class="s0">Directory</span><span class="s2">(</span><span class="s1">'</span><span class="s2">$</span><span class="s0">outputDir</span><span class="s1">/imagenes_excel'</span><span class="s2">);</span>
      <span class="s3">if </span><span class="s2">(!</span><span class="s0">await imagenesDir</span><span class="s2">.</span><span class="s0">exists</span><span class="s2">()) {</span>
        <span class="s0">await imagenesDir</span><span class="s2">.</span><span class="s0">create</span><span class="s2">();</span>
      <span class="s2">}</span>

      <span class="s4">// Procesar imágenes y agregarlas a la carpeta</span>
      <span class="s0">Map</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">, </span><span class="s0">List</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">&gt;&gt; </span><span class="s0">imagenesExportadas </span><span class="s2">= </span><span class="s0">await _exportarImagenes</span><span class="s2">(</span><span class="s0">maquinas</span><span class="s2">, </span><span class="s0">imagenesDir</span><span class="s2">.</span><span class="s0">path</span><span class="s2">);</span>

      <span class="s4">// Agregar datos de máquinas con referencias a imágenes</span>
      <span class="s0">_agregarDatosMaquinas</span><span class="s2">(</span><span class="s0">sheet</span><span class="s2">, </span><span class="s0">maquinas</span><span class="s2">, </span><span class="s0">imagenesExportadas</span><span class="s2">);</span>

      <span class="s4">// Ajustar ancho de columnas</span>
      <span class="s0">_ajustarAnchoColumnas</span><span class="s2">(</span><span class="s0">sheet</span><span class="s2">);</span>

      <span class="s4">// Ruta completa del archivo Excel</span>
      <span class="s0">String outputFile </span><span class="s2">= </span><span class="s1">'</span><span class="s2">$</span><span class="s0">outputDir</span><span class="s1">/</span><span class="s2">$</span><span class="s0">nombreArchivoPredeterminado</span><span class="s1">'</span><span class="s2">;</span>

      <span class="s4">// Guardar el archivo en la ubicación seleccionada</span>
      <span class="s0">List</span><span class="s2">&lt;</span><span class="s0">int</span><span class="s2">&gt;? </span><span class="s0">fileBytes </span><span class="s2">= </span><span class="s0">excel</span><span class="s2">.</span><span class="s0">save</span><span class="s2">();</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s0">fileBytes </span><span class="s2">!= </span><span class="s3">null</span><span class="s2">) {</span>
        <span class="s0">File</span><span class="s2">(</span><span class="s0">outputFile</span><span class="s2">)</span>
          <span class="s2">..</span><span class="s0">createSync</span><span class="s2">(</span><span class="s0">recursive</span><span class="s2">: </span><span class="s3">true</span><span class="s2">)</span>
          <span class="s2">..</span><span class="s0">writeAsBytesSync</span><span class="s2">(</span><span class="s0">fileBytes</span><span class="s2">);</span>

        <span class="s3">return </span><span class="s0">outputFile</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s3">return null</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s3">catch </span><span class="s2">(</span><span class="s0">e</span><span class="s2">) {</span>
      <span class="s0">print</span><span class="s2">(</span><span class="s1">'Error al generar Excel: </span><span class="s2">$</span><span class="s0">e</span><span class="s1">'</span><span class="s2">);</span>
      <span class="s3">return null</span><span class="s2">;</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

  <span class="s4">// Método para exportar imágenes a la carpeta seleccionada</span>
  <span class="s0">static Future</span><span class="s2">&lt;</span><span class="s0">Map</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">, </span><span class="s0">List</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">&gt;&gt;&gt; </span><span class="s0">_exportarImagenes</span><span class="s2">(</span>
      <span class="s0">List</span><span class="s2">&lt;</span><span class="s0">Map</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">, </span><span class="s0">dynamic</span><span class="s2">&gt;&gt; </span><span class="s0">maquinas</span><span class="s2">, </span><span class="s0">String carpetaDestino</span><span class="s2">) </span><span class="s0">async </span><span class="s2">{</span>
    <span class="s0">Map</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">, </span><span class="s0">List</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">&gt;&gt; </span><span class="s0">imagenesExportadas </span><span class="s2">= {};</span>

    <span class="s3">try </span><span class="s2">{</span>
      <span class="s3">for </span><span class="s2">(</span><span class="s3">var </span><span class="s0">maquina </span><span class="s3">in </span><span class="s0">maquinas</span><span class="s2">) {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'fotos'</span><span class="s2">] != </span><span class="s3">null </span><span class="s2">&amp;&amp; </span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'fotos'</span><span class="s2">] </span><span class="s3">is </span><span class="s0">List </span><span class="s2">&amp;&amp; </span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'fotos'</span><span class="s2">].</span><span class="s0">isNotEmpty</span><span class="s2">) {</span>
          <span class="s0">List</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">&gt; </span><span class="s0">fotosOriginales </span><span class="s2">= </span><span class="s0">List</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">&gt;.</span><span class="s0">from</span><span class="s2">(</span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'fotos'</span><span class="s2">]);</span>
          <span class="s0">List</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">&gt; </span><span class="s0">fotosExportadas </span><span class="s2">= [];</span>

          <span class="s4">// Crear subcarpeta para esta máquina</span>
          <span class="s3">final </span><span class="s0">idMaquina </span><span class="s2">= </span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'id'</span><span class="s2">] ?? </span><span class="s1">'maquina'</span><span class="s2">;</span>
          <span class="s3">final </span><span class="s0">placaMaquina </span><span class="s2">= </span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'placa'</span><span class="s2">] ?? </span><span class="s1">''</span><span class="s2">;</span>
          <span class="s3">final </span><span class="s0">carpetaMaquina </span><span class="s2">= </span><span class="s1">'</span><span class="s2">$</span><span class="s0">carpetaDestino</span><span class="s1">/</span><span class="s2">${</span><span class="s0">idMaquina</span><span class="s2">}</span><span class="s1">_</span><span class="s2">$</span><span class="s0">placaMaquina</span><span class="s1">'</span><span class="s2">;</span>

          <span class="s0">Directory</span><span class="s2">(</span><span class="s0">carpetaMaquina</span><span class="s2">).</span><span class="s0">createSync</span><span class="s2">(</span><span class="s0">recursive</span><span class="s2">: </span><span class="s3">true</span><span class="s2">);</span>

          <span class="s4">// Copiar cada imagen</span>
          <span class="s3">for </span><span class="s2">(</span><span class="s0">int i </span><span class="s2">= </span><span class="s5">0</span><span class="s2">; </span><span class="s0">i </span><span class="s2">&lt; </span><span class="s0">fotosOriginales</span><span class="s2">.</span><span class="s0">length</span><span class="s2">; </span><span class="s0">i</span><span class="s2">++) {</span>
            <span class="s3">try </span><span class="s2">{</span>
              <span class="s3">final </span><span class="s0">fotoOriginal </span><span class="s2">= </span><span class="s0">File</span><span class="s2">(</span><span class="s0">fotosOriginales</span><span class="s2">[</span><span class="s0">i</span><span class="s2">]);</span>
              <span class="s3">if </span><span class="s2">(</span><span class="s0">await fotoOriginal</span><span class="s2">.</span><span class="s0">exists</span><span class="s2">()) {</span>
                <span class="s3">final </span><span class="s0">nombreArchivo </span><span class="s2">= </span><span class="s1">'foto_</span><span class="s2">${</span><span class="s0">i </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">}${</span><span class="s0">path</span><span class="s2">.</span><span class="s0">extension</span><span class="s2">(</span><span class="s0">fotosOriginales</span><span class="s2">[</span><span class="s0">i</span><span class="s2">])}</span><span class="s1">'</span><span class="s2">;</span>
                <span class="s3">final </span><span class="s0">rutaDestino </span><span class="s2">= </span><span class="s1">'</span><span class="s2">$</span><span class="s0">carpetaMaquina</span><span class="s1">/</span><span class="s2">$</span><span class="s0">nombreArchivo</span><span class="s1">'</span><span class="s2">;</span>

                <span class="s0">await fotoOriginal</span><span class="s2">.</span><span class="s0">copy</span><span class="s2">(</span><span class="s0">rutaDestino</span><span class="s2">);</span>
                <span class="s0">fotosExportadas</span><span class="s2">.</span><span class="s0">add</span><span class="s2">(</span><span class="s0">rutaDestino</span><span class="s2">);</span>
              <span class="s2">}</span>
            <span class="s2">} </span><span class="s3">catch </span><span class="s2">(</span><span class="s0">e</span><span class="s2">) {</span>
              <span class="s0">print</span><span class="s2">(</span><span class="s1">'Error al copiar imagen: </span><span class="s2">$</span><span class="s0">e</span><span class="s1">'</span><span class="s2">);</span>
            <span class="s2">}</span>
          <span class="s2">}</span>

          <span class="s3">if </span><span class="s2">(</span><span class="s0">fotosExportadas</span><span class="s2">.</span><span class="s0">isNotEmpty</span><span class="s2">) {</span>
            <span class="s0">imagenesExportadas</span><span class="s2">[</span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'id'</span><span class="s2">].</span><span class="s0">toString</span><span class="s2">()] = </span><span class="s0">fotosExportadas</span><span class="s2">;</span>
          <span class="s2">}</span>
        <span class="s2">}</span>
      <span class="s2">}</span>
    <span class="s2">} </span><span class="s3">catch </span><span class="s2">(</span><span class="s0">e</span><span class="s2">) {</span>
      <span class="s0">print</span><span class="s2">(</span><span class="s1">'Error al exportar imágenes: </span><span class="s2">$</span><span class="s0">e</span><span class="s1">'</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s3">return </span><span class="s0">imagenesExportadas</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s4">// Método para agregar encabezados</span>
  <span class="s0">static </span><span class="s3">void </span><span class="s0">_agregarEncabezados</span><span class="s2">(</span><span class="s0">Sheet sheet</span><span class="s2">) {</span>
    <span class="s0">List</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">&gt; </span><span class="s0">headers </span><span class="s2">= [</span>
      <span class="s4">// Información básica</span>
      <span class="s1">'ID'</span><span class="s2">,</span>
      <span class="s1">'Placa'</span><span class="s2">,</span>
      <span class="s1">'Modelo'</span><span class="s2">,</span>
      <span class="s1">'Capacidad'</span><span class="s2">,</span>
      <span class="s1">'Kilometraje'</span><span class="s2">,</span>
      <span class="s1">'BIN'</span><span class="s2">,</span>
      <span class="s1">'Estado'</span><span class="s2">,</span>

      <span class="s4">// Revisión Técnica</span>
      <span class="s1">'Fecha Revisión Técnica'</span><span class="s2">,</span>

      <span class="s4">// Filtros</span>
      <span class="s1">'Modelo Filtro Aceite'</span><span class="s2">,</span>
      <span class="s1">'Fecha Cambio Filtro Aceite'</span><span class="s2">,</span>
      <span class="s1">'Modelo Filtro Aire'</span><span class="s2">,</span>
      <span class="s1">'Fecha Cambio Filtro Aire'</span><span class="s2">,</span>
      <span class="s1">'Modelo Filtro Petróleo'</span><span class="s2">,</span>
      <span class="s1">'Fecha Cambio Filtro Petróleo'</span><span class="s2">,</span>

      <span class="s4">// Otras Revisiones</span>
      <span class="s1">'Modelo Decantador'</span><span class="s2">,</span>
      <span class="s1">'Fecha Revisión Decantador'</span><span class="s2">,</span>

      <span class="s4">// Correas (hasta 6)</span>
      <span class="s1">'Modelo Correa 1'</span><span class="s2">,</span>
      <span class="s1">'Fecha Revisión Correa 1'</span><span class="s2">,</span>
      <span class="s1">'Modelo Correa 2'</span><span class="s2">,</span>
      <span class="s1">'Fecha Revisión Correa 2'</span><span class="s2">,</span>
      <span class="s1">'Modelo Correa 3'</span><span class="s2">,</span>
      <span class="s1">'Fecha Revisión Correa 3'</span><span class="s2">,</span>
      <span class="s1">'Modelo Correa 4'</span><span class="s2">,</span>
      <span class="s1">'Fecha Revisión Correa 4'</span><span class="s2">,</span>
      <span class="s1">'Modelo Correa 5'</span><span class="s2">,</span>
      <span class="s1">'Fecha Revisión Correa 5'</span><span class="s2">,</span>
      <span class="s1">'Modelo Correa 6'</span><span class="s2">,</span>
      <span class="s1">'Fecha Revisión Correa 6'</span><span class="s2">,</span>

      <span class="s4">// Comentarios e imágenes</span>
      <span class="s1">'Comentarios'</span><span class="s2">,</span>
      <span class="s1">'Ruta Imágenes'</span>
    <span class="s2">];</span>

    <span class="s0">sheet</span><span class="s2">.</span><span class="s0">appendRow</span><span class="s2">(</span><span class="s0">headers</span><span class="s2">);</span>

    <span class="s4">// Dar formato a los encabezados</span>
    <span class="s3">for </span><span class="s2">(</span><span class="s0">int i </span><span class="s2">= </span><span class="s5">0</span><span class="s2">; </span><span class="s0">i </span><span class="s2">&lt; </span><span class="s0">headers</span><span class="s2">.</span><span class="s0">length</span><span class="s2">; </span><span class="s0">i</span><span class="s2">++) {</span>
      <span class="s3">var </span><span class="s0">cell </span><span class="s2">= </span><span class="s0">sheet</span><span class="s2">.</span><span class="s0">cell</span><span class="s2">(</span><span class="s0">CellIndex</span><span class="s2">.</span><span class="s0">indexByColumnRow</span><span class="s2">(</span><span class="s0">columnIndex</span><span class="s2">: </span><span class="s0">i</span><span class="s2">, </span><span class="s0">rowIndex</span><span class="s2">: </span><span class="s5">0</span><span class="s2">));</span>
      <span class="s0">cell</span><span class="s2">.</span><span class="s0">cellStyle </span><span class="s2">= </span><span class="s0">CellStyle</span><span class="s2">(</span>
        <span class="s0">bold</span><span class="s2">: </span><span class="s3">true</span><span class="s2">,</span>
        <span class="s0">backgroundColorHex</span><span class="s2">: </span><span class="s1">'#E3F2FD'</span><span class="s2">,  </span><span class="s4">// Color de fondo azul claro</span>
        <span class="s0">horizontalAlign</span><span class="s2">: </span><span class="s0">HorizontalAlign</span><span class="s2">.</span><span class="s0">Center</span><span class="s2">,</span>
      <span class="s2">);</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

  <span class="s4">// Método para agregar datos de máquinas</span>
  <span class="s0">static </span><span class="s3">void </span><span class="s0">_agregarDatosMaquinas</span><span class="s2">(</span>
      <span class="s0">Sheet sheet</span><span class="s2">, </span><span class="s0">List</span><span class="s2">&lt;</span><span class="s0">Map</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">, </span><span class="s0">dynamic</span><span class="s2">&gt;&gt; </span><span class="s0">maquinas</span><span class="s2">, </span><span class="s0">Map</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">, </span><span class="s0">List</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">&gt;&gt; </span><span class="s0">imagenesExportadas</span><span class="s2">) {</span>
    <span class="s3">for </span><span class="s2">(</span><span class="s3">var </span><span class="s0">maquina </span><span class="s3">in </span><span class="s0">maquinas</span><span class="s2">) {</span>
      <span class="s4">// Obtener las correas con soporte para la nueva estructura</span>
      <span class="s0">List</span><span class="s2">&lt;</span><span class="s0">Map</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">, </span><span class="s0">dynamic</span><span class="s2">&gt;&gt; </span><span class="s0">correas </span><span class="s2">= </span><span class="s0">_obtenerCorreas</span><span class="s2">(</span><span class="s0">maquina</span><span class="s2">);</span>

      <span class="s4">// Obtener ruta de imágenes para esta máquina</span>
      <span class="s0">String rutaImagenes </span><span class="s2">= </span><span class="s1">''</span><span class="s2">;</span>
      <span class="s3">if </span><span class="s2">(</span><span class="s0">imagenesExportadas</span><span class="s2">.</span><span class="s0">containsKey</span><span class="s2">(</span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'id'</span><span class="s2">].</span><span class="s0">toString</span><span class="s2">())) {</span>
        <span class="s3">final </span><span class="s0">carpetaImagenes </span><span class="s2">= </span><span class="s0">path</span><span class="s2">.</span><span class="s0">dirname</span><span class="s2">(</span><span class="s0">imagenesExportadas</span><span class="s2">[</span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'id'</span><span class="s2">].</span><span class="s0">toString</span><span class="s2">()]!.</span><span class="s0">first</span><span class="s2">);</span>
        <span class="s0">rutaImagenes </span><span class="s2">= </span><span class="s0">carpetaImagenes</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s0">List</span><span class="s2">&lt;</span><span class="s0">dynamic</span><span class="s2">&gt; </span><span class="s0">rowData </span><span class="s2">= [</span>
        <span class="s4">// Información básica</span>
        <span class="s0">maquina</span><span class="s2">[</span><span class="s1">'id'</span><span class="s2">] ?? </span><span class="s1">''</span><span class="s2">,</span>
        <span class="s0">maquina</span><span class="s2">[</span><span class="s1">'placa'</span><span class="s2">] ?? </span><span class="s1">''</span><span class="s2">,</span>
        <span class="s0">maquina</span><span class="s2">[</span><span class="s1">'modelo'</span><span class="s2">] ?? </span><span class="s1">''</span><span class="s2">,</span>
        <span class="s0">maquina</span><span class="s2">[</span><span class="s1">'capacidad'</span><span class="s2">]?.</span><span class="s0">toString</span><span class="s2">() ?? </span><span class="s1">''</span><span class="s2">,</span>
        <span class="s0">maquina</span><span class="s2">[</span><span class="s1">'kilometraje'</span><span class="s2">]?.</span><span class="s0">toString</span><span class="s2">() ?? </span><span class="s1">''</span><span class="s2">,</span>
        <span class="s0">maquina</span><span class="s2">[</span><span class="s1">'bin'</span><span class="s2">] ?? </span><span class="s1">''</span><span class="s2">,</span>
        <span class="s0">maquina</span><span class="s2">[</span><span class="s1">'estado'</span><span class="s2">] ?? </span><span class="s1">''</span><span class="s2">,</span>

        <span class="s4">// Revisión Técnica</span>
        <span class="s0">_formatearFecha</span><span class="s2">(</span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'fechaRevisionTecnica'</span><span class="s2">]),</span>

        <span class="s4">// Filtros</span>
        <span class="s0">maquina</span><span class="s2">[</span><span class="s1">'modeloFiltroAceite'</span><span class="s2">] ?? </span><span class="s1">''</span><span class="s2">,</span>
        <span class="s0">_formatearFecha</span><span class="s2">(</span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'fechaCambioFiltroAceite'</span><span class="s2">]),</span>
        <span class="s0">maquina</span><span class="s2">[</span><span class="s1">'modeloFiltroAire'</span><span class="s2">] ?? </span><span class="s1">''</span><span class="s2">,</span>
        <span class="s0">_formatearFecha</span><span class="s2">(</span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'fechaCambioFiltroAire'</span><span class="s2">]),</span>
        <span class="s0">maquina</span><span class="s2">[</span><span class="s1">'modeloFiltroPetroleo'</span><span class="s2">] ?? </span><span class="s1">''</span><span class="s2">,</span>
        <span class="s0">_formatearFecha</span><span class="s2">(</span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'fechaCambioFiltroPetroleo'</span><span class="s2">]),</span>

        <span class="s4">// Otras Revisiones</span>
        <span class="s0">maquina</span><span class="s2">[</span><span class="s1">'modeloDecantador'</span><span class="s2">] ?? </span><span class="s1">''</span><span class="s2">,</span>
        <span class="s0">_formatearFecha</span><span class="s2">(</span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'fechaRevisionDecantador'</span><span class="s2">]),</span>
      <span class="s2">];</span>

      <span class="s4">// Agregar datos de correas (hasta 6)</span>
      <span class="s3">for </span><span class="s2">(</span><span class="s0">int i </span><span class="s2">= </span><span class="s5">0</span><span class="s2">; </span><span class="s0">i </span><span class="s2">&lt; </span><span class="s5">6</span><span class="s2">; </span><span class="s0">i</span><span class="s2">++) {</span>
        <span class="s3">if </span><span class="s2">(</span><span class="s0">i </span><span class="s2">&lt; </span><span class="s0">correas</span><span class="s2">.</span><span class="s0">length</span><span class="s2">) {</span>
          <span class="s4">// Agregar modelo de correa</span>
          <span class="s0">rowData</span><span class="s2">.</span><span class="s0">add</span><span class="s2">(</span><span class="s0">correas</span><span class="s2">[</span><span class="s0">i</span><span class="s2">][</span><span class="s1">'modelo'</span><span class="s2">] ?? </span><span class="s1">''</span><span class="s2">);</span>
          <span class="s4">// Agregar fecha de revisión de correa</span>
          <span class="s0">rowData</span><span class="s2">.</span><span class="s0">add</span><span class="s2">(</span><span class="s0">_formatearFecha</span><span class="s2">(</span><span class="s0">correas</span><span class="s2">[</span><span class="s0">i</span><span class="s2">][</span><span class="s1">'fecha'</span><span class="s2">]));</span>
        <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
          <span class="s4">// Agregar espacios vacíos para completar hasta 6 correas</span>
          <span class="s0">rowData</span><span class="s2">.</span><span class="s0">add</span><span class="s2">(</span><span class="s1">''</span><span class="s2">);</span>
          <span class="s0">rowData</span><span class="s2">.</span><span class="s0">add</span><span class="s2">(</span><span class="s1">''</span><span class="s2">);</span>
        <span class="s2">}</span>
      <span class="s2">}</span>

      <span class="s4">// Comentarios</span>
      <span class="s0">rowData</span><span class="s2">.</span><span class="s0">add</span><span class="s2">(</span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'comentario'</span><span class="s2">] ?? </span><span class="s1">''</span><span class="s2">);</span>

      <span class="s4">// Ruta de imágenes</span>
      <span class="s0">rowData</span><span class="s2">.</span><span class="s0">add</span><span class="s2">(</span><span class="s0">rutaImagenes</span><span class="s2">);</span>

      <span class="s4">// Agregar la fila completa al Excel</span>
      <span class="s0">sheet</span><span class="s2">.</span><span class="s0">appendRow</span><span class="s2">(</span><span class="s0">rowData</span><span class="s2">);</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

  <span class="s4">// Método para obtener la lista de correas de una máquina</span>
  <span class="s0">static List</span><span class="s2">&lt;</span><span class="s0">Map</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">, </span><span class="s0">dynamic</span><span class="s2">&gt;&gt; </span><span class="s0">_obtenerCorreas</span><span class="s2">(</span><span class="s0">Map</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">, </span><span class="s0">dynamic</span><span class="s2">&gt; </span><span class="s0">maquina</span><span class="s2">) {</span>
    <span class="s4">// Verificar si existe la nueva estructura de correas</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'correas'</span><span class="s2">] != </span><span class="s3">null </span><span class="s2">&amp;&amp; </span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'correas'</span><span class="s2">] </span><span class="s3">is </span><span class="s0">List</span><span class="s2">) {</span>
      <span class="s3">try </span><span class="s2">{</span>
        <span class="s3">return </span><span class="s0">List</span><span class="s2">&lt;</span><span class="s0">Map</span><span class="s2">&lt;</span><span class="s0">String</span><span class="s2">, </span><span class="s0">dynamic</span><span class="s2">&gt;&gt;.</span><span class="s0">from</span><span class="s2">(</span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'correas'</span><span class="s2">]);</span>
      <span class="s2">} </span><span class="s3">catch </span><span class="s2">(</span><span class="s0">e</span><span class="s2">) {</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s1">'Error al procesar correas: </span><span class="s2">$</span><span class="s0">e</span><span class="s1">'</span><span class="s2">);</span>
      <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s4">// Compatibilidad con versión anterior (una sola correa)</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'modeloCorrea'</span><span class="s2">] != </span><span class="s3">null</span><span class="s2">) {</span>
      <span class="s3">return </span><span class="s2">[{</span>
        <span class="s1">'modelo'</span><span class="s2">: </span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'modeloCorrea'</span><span class="s2">],</span>
        <span class="s1">'fecha'</span><span class="s2">: </span><span class="s0">maquina</span><span class="s2">[</span><span class="s1">'fechaRevisionCorrea'</span><span class="s2">],</span>
      <span class="s2">}];</span>
    <span class="s2">}</span>

    <span class="s3">return </span><span class="s2">[];</span>
  <span class="s2">}</span>

  <span class="s4">// Método para ajustar ancho de columnas</span>
  <span class="s0">static </span><span class="s3">void </span><span class="s0">_ajustarAnchoColumnas</span><span class="s2">(</span><span class="s0">Sheet sheet</span><span class="s2">) {</span>
    <span class="s4">// La biblioteca Excel no permite ajustar fácilmente el ancho de columnas</span>
    <span class="s4">// Sin embargo, podemos definir una numeración de columnas para hacerlas más legibles</span>
    <span class="s0">int colNum </span><span class="s2">= </span><span class="s5">0</span><span class="s2">;</span>

    <span class="s4">// Grupo: Información básica (columnas 0-6)</span>
    <span class="s3">for </span><span class="s2">(</span><span class="s0">int i </span><span class="s2">= </span><span class="s5">0</span><span class="s2">; </span><span class="s0">i </span><span class="s2">&lt;= </span><span class="s5">6</span><span class="s2">; </span><span class="s0">i</span><span class="s2">++) {</span>
      <span class="s3">var </span><span class="s0">cell </span><span class="s2">= </span><span class="s0">sheet</span><span class="s2">.</span><span class="s0">cell</span><span class="s2">(</span><span class="s0">CellIndex</span><span class="s2">.</span><span class="s0">indexByColumnRow</span><span class="s2">(</span><span class="s0">columnIndex</span><span class="s2">: </span><span class="s0">i</span><span class="s2">, </span><span class="s0">rowIndex</span><span class="s2">: </span><span class="s5">0</span><span class="s2">));</span>
      <span class="s0">cell</span><span class="s2">.</span><span class="s0">value </span><span class="s2">= </span><span class="s1">&quot;</span><span class="s2">${</span><span class="s0">colNum </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">}</span><span class="s1">. </span><span class="s2">${</span><span class="s0">cell</span><span class="s2">.</span><span class="s0">value</span><span class="s2">.</span><span class="s0">toString</span><span class="s2">()}</span><span class="s1">&quot;</span><span class="s2">;</span>
      <span class="s0">colNum</span><span class="s2">++;</span>
    <span class="s2">}</span>

    <span class="s4">// Grupo: Revisión Técnica (columna 7)</span>
    <span class="s3">var </span><span class="s0">cellRT </span><span class="s2">= </span><span class="s0">sheet</span><span class="s2">.</span><span class="s0">cell</span><span class="s2">(</span><span class="s0">CellIndex</span><span class="s2">.</span><span class="s0">indexByColumnRow</span><span class="s2">(</span><span class="s0">columnIndex</span><span class="s2">: </span><span class="s5">7</span><span class="s2">, </span><span class="s0">rowIndex</span><span class="s2">: </span><span class="s5">0</span><span class="s2">));</span>
    <span class="s0">cellRT</span><span class="s2">.</span><span class="s0">value </span><span class="s2">= </span><span class="s1">&quot;</span><span class="s2">${</span><span class="s0">colNum </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">}</span><span class="s1">. </span><span class="s2">${</span><span class="s0">cellRT</span><span class="s2">.</span><span class="s0">value</span><span class="s2">.</span><span class="s0">toString</span><span class="s2">()}</span><span class="s1">&quot;</span><span class="s2">;</span>
    <span class="s0">colNum</span><span class="s2">++;</span>

    <span class="s4">// Grupo: Filtros (columnas 8-13)</span>
    <span class="s3">for </span><span class="s2">(</span><span class="s0">int i </span><span class="s2">= </span><span class="s5">8</span><span class="s2">; </span><span class="s0">i </span><span class="s2">&lt;= </span><span class="s5">13</span><span class="s2">; </span><span class="s0">i</span><span class="s2">++) {</span>
      <span class="s3">var </span><span class="s0">cell </span><span class="s2">= </span><span class="s0">sheet</span><span class="s2">.</span><span class="s0">cell</span><span class="s2">(</span><span class="s0">CellIndex</span><span class="s2">.</span><span class="s0">indexByColumnRow</span><span class="s2">(</span><span class="s0">columnIndex</span><span class="s2">: </span><span class="s0">i</span><span class="s2">, </span><span class="s0">rowIndex</span><span class="s2">: </span><span class="s5">0</span><span class="s2">));</span>
      <span class="s0">cell</span><span class="s2">.</span><span class="s0">value </span><span class="s2">= </span><span class="s1">&quot;</span><span class="s2">${</span><span class="s0">colNum </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">}</span><span class="s1">. </span><span class="s2">${</span><span class="s0">cell</span><span class="s2">.</span><span class="s0">value</span><span class="s2">.</span><span class="s0">toString</span><span class="s2">()}</span><span class="s1">&quot;</span><span class="s2">;</span>
      <span class="s0">colNum</span><span class="s2">++;</span>
    <span class="s2">}</span>

    <span class="s4">// Grupo: Decantador (columnas 14-15)</span>
    <span class="s3">for </span><span class="s2">(</span><span class="s0">int i </span><span class="s2">= </span><span class="s5">14</span><span class="s2">; </span><span class="s0">i </span><span class="s2">&lt;= </span><span class="s5">15</span><span class="s2">; </span><span class="s0">i</span><span class="s2">++) {</span>
      <span class="s3">var </span><span class="s0">cell </span><span class="s2">= </span><span class="s0">sheet</span><span class="s2">.</span><span class="s0">cell</span><span class="s2">(</span><span class="s0">CellIndex</span><span class="s2">.</span><span class="s0">indexByColumnRow</span><span class="s2">(</span><span class="s0">columnIndex</span><span class="s2">: </span><span class="s0">i</span><span class="s2">, </span><span class="s0">rowIndex</span><span class="s2">: </span><span class="s5">0</span><span class="s2">));</span>
      <span class="s0">cell</span><span class="s2">.</span><span class="s0">value </span><span class="s2">= </span><span class="s1">&quot;</span><span class="s2">${</span><span class="s0">colNum </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">}</span><span class="s1">. </span><span class="s2">${</span><span class="s0">cell</span><span class="s2">.</span><span class="s0">value</span><span class="s2">.</span><span class="s0">toString</span><span class="s2">()}</span><span class="s1">&quot;</span><span class="s2">;</span>
      <span class="s0">colNum</span><span class="s2">++;</span>
    <span class="s2">}</span>

    <span class="s4">// Grupo: Correas (columnas 16-27)</span>
    <span class="s3">for </span><span class="s2">(</span><span class="s0">int i </span><span class="s2">= </span><span class="s5">16</span><span class="s2">; </span><span class="s0">i </span><span class="s2">&lt;= </span><span class="s5">27</span><span class="s2">; </span><span class="s0">i</span><span class="s2">++) {</span>
      <span class="s3">var </span><span class="s0">cell </span><span class="s2">= </span><span class="s0">sheet</span><span class="s2">.</span><span class="s0">cell</span><span class="s2">(</span><span class="s0">CellIndex</span><span class="s2">.</span><span class="s0">indexByColumnRow</span><span class="s2">(</span><span class="s0">columnIndex</span><span class="s2">: </span><span class="s0">i</span><span class="s2">, </span><span class="s0">rowIndex</span><span class="s2">: </span><span class="s5">0</span><span class="s2">));</span>
      <span class="s0">cell</span><span class="s2">.</span><span class="s0">value </span><span class="s2">= </span><span class="s1">&quot;</span><span class="s2">${</span><span class="s0">colNum </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">}</span><span class="s1">. </span><span class="s2">${</span><span class="s0">cell</span><span class="s2">.</span><span class="s0">value</span><span class="s2">.</span><span class="s0">toString</span><span class="s2">()}</span><span class="s1">&quot;</span><span class="s2">;</span>
      <span class="s0">colNum</span><span class="s2">++;</span>
    <span class="s2">}</span>

    <span class="s4">// Comentarios y ruta de imágenes (columnas 28-29)</span>
    <span class="s3">var </span><span class="s0">cellComentario </span><span class="s2">= </span><span class="s0">sheet</span><span class="s2">.</span><span class="s0">cell</span><span class="s2">(</span><span class="s0">CellIndex</span><span class="s2">.</span><span class="s0">indexByColumnRow</span><span class="s2">(</span><span class="s0">columnIndex</span><span class="s2">: </span><span class="s5">28</span><span class="s2">, </span><span class="s0">rowIndex</span><span class="s2">: </span><span class="s5">0</span><span class="s2">));</span>
    <span class="s0">cellComentario</span><span class="s2">.</span><span class="s0">value </span><span class="s2">= </span><span class="s1">&quot;</span><span class="s2">${</span><span class="s0">colNum </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">}</span><span class="s1">. </span><span class="s2">${</span><span class="s0">cellComentario</span><span class="s2">.</span><span class="s0">value</span><span class="s2">.</span><span class="s0">toString</span><span class="s2">()}</span><span class="s1">&quot;</span><span class="s2">;</span>
    <span class="s0">colNum</span><span class="s2">++;</span>

    <span class="s3">var </span><span class="s0">cellImagenes </span><span class="s2">= </span><span class="s0">sheet</span><span class="s2">.</span><span class="s0">cell</span><span class="s2">(</span><span class="s0">CellIndex</span><span class="s2">.</span><span class="s0">indexByColumnRow</span><span class="s2">(</span><span class="s0">columnIndex</span><span class="s2">: </span><span class="s5">29</span><span class="s2">, </span><span class="s0">rowIndex</span><span class="s2">: </span><span class="s5">0</span><span class="s2">));</span>
    <span class="s0">cellImagenes</span><span class="s2">.</span><span class="s0">value </span><span class="s2">= </span><span class="s1">&quot;</span><span class="s2">${</span><span class="s0">colNum </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">}</span><span class="s1">. </span><span class="s2">${</span><span class="s0">cellImagenes</span><span class="s2">.</span><span class="s0">value</span><span class="s2">.</span><span class="s0">toString</span><span class="s2">()}</span><span class="s1">&quot;</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s4">// Método para formatear fecha</span>
  <span class="s0">static String _formatearFecha</span><span class="s2">(</span><span class="s0">String</span><span class="s2">? </span><span class="s0">fechaIso</span><span class="s2">) {</span>
    <span class="s3">if </span><span class="s2">(</span><span class="s0">fechaIso </span><span class="s2">== </span><span class="s3">null </span><span class="s2">|| </span><span class="s0">fechaIso</span><span class="s2">.</span><span class="s0">isEmpty</span><span class="s2">) {</span>
      <span class="s3">return </span><span class="s1">'No registrada'</span><span class="s2">;</span>
    <span class="s2">}</span>
    <span class="s3">try </span><span class="s2">{</span>
      <span class="s3">final </span><span class="s0">DateTime fecha </span><span class="s2">= </span><span class="s0">DateTime</span><span class="s2">.</span><span class="s0">parse</span><span class="s2">(</span><span class="s0">fechaIso</span><span class="s2">);</span>
      <span class="s3">return </span><span class="s1">'</span><span class="s2">${</span><span class="s0">fecha</span><span class="s2">.</span><span class="s0">day</span><span class="s2">}</span><span class="s1">/</span><span class="s2">${</span><span class="s0">fecha</span><span class="s2">.</span><span class="s0">month</span><span class="s2">}</span><span class="s1">/</span><span class="s2">${</span><span class="s0">fecha</span><span class="s2">.</span><span class="s0">year</span><span class="s2">}</span><span class="s1">'</span><span class="s2">;</span>
    <span class="s2">} </span><span class="s3">catch </span><span class="s2">(</span><span class="s0">e</span><span class="s2">) {</span>
      <span class="s3">return </span><span class="s1">'Fecha inválida'</span><span class="s2">;</span>
    <span class="s2">}</span>
  <span class="s2">}</span>
<span class="s2">}</span></pre>
</body>
</html>